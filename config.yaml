# UPS Monitor Configuration File
# All sections are optional - features are disabled if not configured

# ==============================================================================
# UPS CONNECTION
# ==============================================================================
ups:
  # UPS identifier in format NAME@HOST or just NAME for local
  name: "UPS@192.168.178.11"
  # Seconds between status checks
  check_interval: 1
  # Number of stale data attempts before declaring connection lost
  max_stale_data_tolerance: 3

# ==============================================================================
# SHUTDOWN TRIGGERS
# ==============================================================================
triggers:
  # Shutdown when battery percentage falls below this value
  low_battery_threshold: 20

  # Shutdown when estimated runtime falls below this (seconds)
  # 600 = 10 minutes
  critical_runtime_threshold: 600

  # Battery depletion tracking
  depletion:
    # Window for calculating depletion rate (seconds)
    window: 300
    # Shutdown when depletion rate exceeds this (%/minute)
    critical_rate: 15.0
    # Grace period after power loss before enforcing depletion rate (seconds)
    grace_period: 90

  # Extended time on battery safety net
  extended_time:
    # Enable shutdown after extended time on battery
    enabled: true
    # Time threshold (seconds) - 900 = 15 minutes
    threshold: 900

# ==============================================================================
# BEHAVIOR
# ==============================================================================
behavior:
  # Dry-run mode - log actions but don't execute them
  dry_run: false

# ==============================================================================
# LOGGING
# ==============================================================================
logging:
  # Log file path (leave empty to disable file logging)
  file: "/var/log/ups-monitor.log"
  # State file for current UPS status
  state_file: "/var/run/ups-monitor.state"
  # Battery history file for depletion tracking
  battery_history_file: "/var/run/ups-battery-history"

# ==============================================================================
# NOTIFICATIONS (via Apprise)
# ==============================================================================
# Apprise supports 100+ notification services
# See: https://github.com/caronc/apprise/wiki
notifications:
  # Optional title - omit or set to null for no title
  # Useful for multi-instance deployments to identify the source system
  title: "âš¡ Homelab UPS"  # or null for no title

  # Avatar/icon URL (supported by Discord, Slack, and others)
  avatar_url: "https://raw.githubusercontent.com/m4r1k/Eneru/main/docs/images/eneru-avatar.png"

  # Timeout for notification delivery (seconds)
  timeout: 10

  # Notification service URLs
  urls:
    # Discord
    - "discord://webhook_id/webhook_token"

    # Telegram
    # - "telegram://bot_token/chat_id"

    # Slack
    # - "slack://token_a/token_b/token_c/#channel"

    # ntfy (self-hosted or ntfy.sh)
    # - "ntfy://topic"
    # - "ntfy://user:password@hostname/topic"

    # Pushover
    # - "pushover://user_key@app_token"

    # Gotify
    # - "gotify://hostname/token"

    # Matrix
    # - "matrix://user:password@hostname/#room"

    # Email
    # - "mailto://user:password@smtp.example.com?to=admin@example.com"

    # Home Assistant
    # - "hassio://hostname/access_token"

    # Generic Webhook
    # - "json://hostname/path"

# ==============================================================================
# LEGACY DISCORD SUPPORT (automatically converted to Apprise)
# ==============================================================================
# If you have an existing Discord configuration, it will be automatically
# converted to use Apprise. You can keep using this format:
#
# discord:
#   webhook_url: "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"
#   timeout: 3

# ==============================================================================
# SHUTDOWN SEQUENCE
# ==============================================================================
# Each section can be removed or set to enabled: false to skip

# Virtual Machines (libvirt/KVM)
virtual_machines:
  enabled: true
  # Maximum time to wait for graceful shutdown before force-destroying (seconds)
  max_wait: 30

# Container Runtime (Docker/Podman)
containers:
  enabled: true
  # Runtime to use: "auto", "docker", or "podman"
  # auto = detect available runtime (prefers podman)
  runtime: "auto"
  # Timeout for stop command (seconds)
  stop_timeout: 60

  # Compose files to shutdown (in order, best effort)
  # Each file is processed with 'docker/podman compose -f <path> down'
  # Compose files are stopped BEFORE remaining containers
  # Format: path string or {path: "/path", stop_timeout: 120}
  compose_files:
  #  - "/opt/critical-db/docker-compose.yml"
  #  - path: "/opt/app-stack/docker-compose.yml"
  #    stop_timeout: 120  # Override global timeout for this file

  # After compose files are stopped, shutdown all remaining containers
  # Set to false if you only want to stop compose stacks
  shutdown_all_remaining_containers: true

  # For Podman: stop all user containers as well (rootless)
  # Requires running as root with loginctl enable-linger for each user
  include_user_containers: false

# Filesystem Operations
filesystems:
  # Sync filesystems before shutdown
  sync_enabled: true

  # Unmount configuration
  unmount:
    enabled: true
    # Timeout per mount point (seconds)
    timeout: 15
    # List of mount points to unmount
    # Format: path or {path: "/mnt/path", options: "-l"}
    mounts:
      - "/mnt/media"
      - path: "/mnt/nas"
        options: "-l"  # lazy unmount for network mounts
      - "/mnt/backup"

# Remote Server Shutdown
# Define multiple remote servers to shutdown via SSH
# Each server can have pre_shutdown_commands to gracefully stop services before shutdown
remote_servers:
  - name: "Synology NAS"
    enabled: true
    host: "192.168.178.229"
    user: "nas-admin"
    # SSH connection timeout (seconds)
    connect_timeout: 10
    # Command execution timeout (seconds) - default for pre_shutdown_commands
    command_timeout: 30
    # Shutdown command (default: "sudo shutdown -h now")
    shutdown_command: "sudo -i synoshutdown -s"
    # SSH options (optional)
    ssh_options:
      - "-o StrictHostKeyChecking=no"

  # Example: Proxmox server with VMs and containers
  # - name: "Proxmox Host"
  #   enabled: true
  #   host: "192.168.178.100"
  #   user: "root"
  #   command_timeout: 30
  #   # Pre-shutdown commands run in order before the final shutdown
  #   # Predefined actions: stop_containers, stop_vms, stop_proxmox_vms,
  #   #   stop_proxmox_cts, stop_xcpng_vms, stop_esxi_vms, stop_compose, sync
  #   pre_shutdown_commands:
  #     - action: "stop_proxmox_vms"
  #       timeout: 120  # Override default timeout
  #     - action: "stop_proxmox_cts"
  #       timeout: 60
  #     - action: "sync"
  #   shutdown_command: "shutdown -h now"

  # Example: Docker server with compose stacks
  # - name: "Docker Server"
  #   enabled: true
  #   host: "192.168.178.101"
  #   user: "root"
  #   pre_shutdown_commands:
  #     - action: "stop_compose"
  #       path: "/opt/myapp/docker-compose.yml"
  #       timeout: 120
  #     - action: "stop_containers"
  #       timeout: 60
  #     - command: "systemctl stop my-critical-service"  # Custom command
  #       timeout: 30
  #     - action: "sync"
  #   shutdown_command: "shutdown -h now"

# Local Server Shutdown
local_shutdown:
  enabled: true
  # Shutdown command (default: "shutdown -h now")
  command: "shutdown -h now"
  # Additional message for shutdown command
  message: "UPS battery critical - emergency shutdown"
